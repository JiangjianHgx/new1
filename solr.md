### 介绍一下你的搜索模块

商品搜索模块包含==商品搜索、索引管理功能==：

#### 商品搜索

采用spring data solr 框架查询solr全文检索服务器。前端使用AngularJS绑定关键字（复制域：标题、分类、商家、品牌）、价格等查询，调用spring data solr的API根据关键字分页查询结果，并且根据关键字查询相关的分类、品牌、规格等筛选条件一并返回给页面。在页面点击分类、品牌、规格、价格也会请求后台再次根据关键字查询和点击的条件筛选。

### 索引管理

solr全文检索服务器的索引库存储sku商品信息（对应数据库的tb_item表），运营商后台审核商品时，如果审核通过，则通过ActiveMQ将商品ID发送给索引同步服务，索引同步服务拿到商品ID查询查询该商品ID的sku列表信息，并导入到solr服务器索引库。同时如果商品删除、下架也会将索引库的索引同步删除。

#### 索引库有哪几个域

普通域Field：分别是id,item_goodsid,item_title,item_price,item_image,item_category,item_seller,item_brand。其中title(标题)和seller(商家)采用中文分词(type设为配置的中文分词器类型),image不会用到搜索，只是我们用来展示，故indexed设为false.而id我们也不会用来搜索，只是为了点击能够跳到商品详情页，才设置这个Field.

复制域：item_keywords，这个域绑定搜索框，这个域中的值来自标题、分类、商家、品牌，不需要存储，其stored设为false.

动态域：item_spec_* ，Map类型，此域中的值不确定。

## 为什么使用solr来进行查询？

1. 数据库中不能分词

2. 在数据库中只能使用Like来模糊搜索，低效，慢

3. 电商项目中，使用搜索会承担很大的压力，每个人过来搜一下，数据库扛不住压力

   所以使用更专业的工具实现搜索功能，把数据库中的内容导入到solr的索引库中，并且随着数据的变化而变化。

   ## 如何处理数据量大，并发量高的搜索？

   当处理数据量大，并发量高的搜索的时候，一个solr服务是不可能满足要求的，所以此时需要SolrCloud来解决，solr本身是不支持分布式的，所以使用的是第三方依赖zookeeper+solr来实现。

###你们系统中搜索是怎么实现的？

我们采用了solr做为全文检索服务器，来实现搜索功能。我们配置solr库中的域，从数据库中把相关的数据导入solr服务器的solr库，例如商品搜索页面搜索功能，我们将商品的标题、品牌、分类、商家等商品表数据（sku)导入索引库，调用spring data solr的AP实现对solr的操作I完成查询，并返回在页面显示。

### 搜索功能如何处理分词？新上市的商品如何处理分词？

在项目中搜索功能使用solr来实现，我们在solr服务器中配置中文分词器，项目里使用的是IKAnalyzer。新上市的商品可能会含有新词，我们会将新词添加进中文分词器的扩展词典中。

### Solr介绍

Solr是一种开源，基于Lucene Java的搜索服务器，主要用作全文检索。安装和配置比较简单，附带一个基于HTTP的管理界面。可以使用solr的表现优异的基本搜索功能。

solr（服务端+客户端）

solr服务器搭建：（安装就是解压一个war包，添加一些jar包，配置schema.xml）

1. 全文检索服务器solr运行环境依赖于servlet容器，可以采用tomcat作为运行环境。
2. 创建solrhome索引库，同时在schema.xml文件配置field域和fieldtype来配置中文分词器。
3. 在tomcat的solr项目的web.xml中指定solrhome的位置。

solr的客户端：

1. 客户端操作可以用solrJ或者spring-data-solr,
2. solr的客户端，主要就是学会索引库的操作（增、删、改）和各种条件的搜索（普通域查询、复制域查询、动态域查询、分页查询、分组查询、高亮查询、过滤查询、区间查询、排序查询），

## solr全文检索原理

### 全文检索

什么是全文检索？

数据可以分为2种：结构化和非结构化数据。

1. 结构化数据：具有固定格式或有限长度的数据，如数据库数据
2. 非结构化数据：不定长或无固定格式的数据，如邮件，word文档

非结构化数据又叫全文数据。

按照数据的分类，搜索页分为2种：

1. 对结构化数据的搜索：如对数据库的搜索，用SQL语句
2. 对非结构化数据的搜索，如windows 的搜索也可以搜索文件内容，Linux 下的 grep 命令，再如用 Google 和百度可以搜索大量内容数据 。

#### 查询非结构化数据的方式：例如从文本中找出包含某一个单词的文件

1. 目测，一个一个打开，逐个查看
2. 使用程序将文档读取到内存中，然后匹配，顺序扫描
3. 把非结构的数据变成结构化的数据：先根据一定的规则（例如根据空格）进行字符串拆分，得到一个单词列表，基于单词列表创建一个索引。然后查询索引，根据单词和文档的对应关系找的文档列表。这个过程叫做全文索引。
4. 索引：一个为了提高查询速度，创建的某种数据结构的集合。

先创建索引然后查询索引的过程叫做全文检索。索引一次创建可以多次使用，表现为每次查询速度很快。

#### Solr全文检索原理

Solr底层基于Lucene.Lucene的原理主要包含索引创建和索引搜索两部分。

索引创建：将原始文档（数据源）使用分词组件来将数据源内容拆分为一个一个的单词，期间还会去点标点符号去点停用词。经过分词后会得到许多词元，接着将这些词元传递给语言处理组件，语言处理组件主要就是将大写转为小写等功能，经过语言处理组件后得到语汇单元（term），最后对语汇单元（term）创建索引形成以语汇单元term的反向索引。反向索引是以term为开头的一个文档链表，只要原始文档包含term这个语汇单元的都会出现在该termde 文档链表中。

索引搜索：将需要查询的关键字先进行分词，得到语汇单元term,然后将这些语汇单元的文档链表返回即可得到原始文档的内容。

## ElasSearch对比Solr

1. solr利用Zookeeper进行分布式管理，而elasticsearch自身带有分布式协调管理功能。
2. solr支持更多格式的数据，而elasticsearch仅支持json文件格式。
3. solr官方提供放入功能更多，而elasticsearch本身更注重核心功能，高级功能多有第三方插件提供。
4. solr在传统的搜索应用中表现好于elassearch,但在处理实时搜索应用时效率明细低于elasticsearch。

### 如何实现按销量、评价排序？

1. 首先在solr库中要设置一个域item_salecount(存储销量数据，销量数据的值来自订单表，并且我们取它的值为近一个月的累计销量总和)
2. 为了不给solr服务器造成太大压力，我们用spring task做了个定时器，让它每天凌晨定时更新一次索引库数据。
3. 评价其实也和销量排序差不多，只是评价分好评、中评、差评，我们采用加权作为评价总分，最后再排序。



如何？